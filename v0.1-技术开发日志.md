# v0.1 技术开发日志（MVP）

**版本**: v0.1.16  
**更新时间**: 2025-11-11

> 说明：遵循工作区规则——每次更新记得更新版本号；模块化开发，保持代码清晰。

## 环境与依赖（已完成部分）
- 运行环境：Windows + Python 3.13（虚拟环境 `.venv`）。
- 依赖（已安装）：
  - Flask（Web 界面）
  - PyYAML（配置）
  - duckduckgo-search（公开文本检索）
  - lxml（由依赖自动安装）
- 配置文件：`舆情分析/mvp/config.yaml`（已启用版本、配额、时间窗、语言与 Web 设置）。

## 目录约定（规划）
- `舆情分析/mvp/`：MVP 源码目录（主入口、调度、agents、report）。
- `舆情分析/knowledge/`：本地知识库（可选）。
- `舆情分析/output/`：报告输出目录（带时间戳与版本号）。
- 文档：
  - `系统说明.md`
  - `架构拆解-BettaFish.md`
  - `v0.1-范围与迭代.md`
  - `v0.1-技术开发日志.md`

## 开发任务与状态（v0.1）
- Orchestrator（主流程调度）
  - 状态：进行中
  - 说明：基本流程在 `app.py` 中完成一次检索与分析；后续抽离为独立模块支持多轮与停止条件。
- QueryAgent（文本检索）
  - 状态：部分完成
  - 说明：已实现 DuckDuckGo 搜索，统一结构返回（title/href/body/source）；后续扩展更多来源。
- SearchAdapter（来源适配器）
  - 状态：已完成（DuckDuckGo）+ 新增 RSS 新闻源（基础版）
  - 说明：支持通过 feedparser 接入 RSS 源；按关键词与时间窗过滤并统一结构返回；后续扩展更多新闻/社区来源与权重控制。
- Parser/Normalizer（清洗规范化）
  - 状态：已完成（基础版）
  - 说明：中文过滤、按 URL 去重、关键词相关性打分与排序。
- DedupCanon（去重归一）
  - 状态：已完成（基础版）
  - 说明：按链接归一去重；后续考虑标题相似度去重。
- RelevanceScorer（相关性打分）
  - 状态：已完成（基础版）
  - 说明：关键词覆盖率 + 命中词数作为初版打分；后续加入时间与来源权重。
- Summarizer（摘要与观点倾向）
  - 状态：已完成（基础版）
  - 说明：正/负/中关键词词典统计，生成简要倾向总结。
- ReportGenerator（模板化报告）
  - 状态：已完成（Web 版，增强）
  - 说明：HTML 模板输出（summary、代表链接、建议），新增“数据说明与配置摘要”（生成时间、时间窗、配额、语言过滤、来源与免责声明）；已支持 Markdown 导出到 output（含版本号与时间戳）。
- ConfigManager（配置与版本）
  - 状态：已完成（基础版）
  - 说明：加载 `config.yaml`，支持版本号与 Web 设置；页面显示 v0.1.5；支持域名白/黑名单、启用新闻源与 RSS 列表配置。

## 决策记录
- 简化范围：只保留 C1（文本），先达成“可用画像”。
- 迭代方法：一轮粗搜 + 可选第二轮增强；满足停止条件即收敛。
- 合规优先：尽量使用公开接口与搜索，控制速率与访问频次。

## 已知问题与待解决
- 来源权重表需初版维护（域名权威度）。
- 情感词典需要最小版（中文正/负/中）。
- 去重策略在新闻聚合页上需增强（标题模板化导致相似度偏高）。

## 后续 TODO（按优先级）
- 适配更多来源（新闻/社区）并统一结构。
- 增加一轮简化迭代逻辑（追问计划：增补关键词/调整时间窗）。
- 报告中加入基础统计图（词频/平台分布占位）。
- 预留 Media/Insight 接口，便于 v0.3+接入。

## 未完成工作清单（v0.2 目标）
为避免遗忘，集中记录当前尚未完成但已规划的关键能力与实现任务：

- 全文抓取与正文抽取（Content Fetcher）
  - HTTP 抓取、超时与重试、反爬与代理支持、编码与压缩处理。
  - 正文抽取（优先使用 trafilatura/boilerpipe 类库或规则），清理脚本与导航噪音。
  - 归档兜底（如文本快照/存档服务），失败回退策略与日志。
- 语义理解与检索策略（LLM Query Planner）
  - 从用户问题中识别实体/别名/方面，生成多关键字与英文别名的检索计划。
  - 面向来源的策略选择（网页/新闻/RSS/国内搜索），以及时间窗与配额自动调优。
- 高质量总结与反思（LLM Summarizer + Reflection）
  - 结合全文内容生成高质量摘要与观点分布；给出证据链链接。
  - 反思“缺了什么”，驱动二次检索与补充；设定停止条件（覆盖度/稳定性）。
- 迭代编排（Orchestrator 2.0）
  - 检索→抽取→总结→反思的循环流程与状态管理；可视化进度与调试日志。
- 覆盖度与质量度量（Metrics）
  - 来源多样性、时间新鲜度、域名权威度、用户满意度阈值；报告中展示覆盖率。
- 缓存与复用（Storage/RAG）
  - 抓取内容的本地缓存与去重（Content-ID）；避免重复请求；可选向量索引用于复用。
- 来源扩展与鲁棒性
  - 扩展 RSS 列表（中/英文主流媒体与行业站点）；加入国内搜索（如 Bing/搜狗）备选。
  - 强化 Baidu 适配器：处理跳转与解码、结果页结构变更的解析规则。
  - 代理/网络错误处理与指数退避；速率限制与合规访问。
- 自动化测试与监控
  - Fetcher/Orchestrator/Summarizer 的单测与集成测试；冒烟测试覆盖 Baidu 解析。
  - 运行日志与错误横幅（UI），便于定位网络或来源限制。
- UI 与可视化增强
  - 迭代进度条、步骤面板、Fallback 使用徽标；导出选项（Markdown/HTML）。
- 配置与文档
  - stop_thresholds/max_iterations 等参数化；域名权重独立配置文件。
  - 开发者指南/用户指南/网络故障排查文档。

### 里程碑规划（草案）
- v0.2.0：落地“全文抓取 + LLM 策略 + 高质量总结与反思 + 迭代编排”。
- v0.2.1：来源扩展、缓存/RAG、覆盖度度量与报告增强。
- v0.2.x：性能与鲁棒性优化、更多 UI 反馈与自动化测试完善。

## 更新记录
- v0.1.17：接入火山引擎 Ark LLM（agents/llm_client_volc.py）；更新 llm_planner.py 优先使用 Volc Ark；新增 processing/orchestrator.py 实现“每次5条→LLM摘要筛选→符合后抓全文→LLM综合判断→不符合继续循环”的迭代编排；配置 mvp/config.yaml 新增 llm 与 loop 设置，版本号到 0.1.17；下一步改造 app.py 报告路由以使用 orchestrator 输出 items/summary/debug。
- v0.1.16：UI 简化为“仅输入问题”，由 LLM/规则自动规划检索策略；默认国内优先（Baidu + 国内RSS），关闭 DuckDuckGo；报告页支持“展开/收起全文”；降低抓取与结果配额以提速；同步配置版本。
- v0.1.15：集成 Content Fetcher（processing/fetcher.py），为前TopK链接抓取正文并用于摘要；新增配置 fetcher.enabled/top_k/timeout；同步版本到 v0.1.15。
- v0.1.14：文档维护——新增“未完成工作清单（v0.2 目标）”与里程碑规划；同步版本号为 v0.1.14。
- v0.1.4：扩展 SearchAdapter，新增 RSS 新闻源（feedparser）；配置新增 enable_news 与 news_feeds；报告与导出显示来源类型（DuckDuckGo + RSS）。
- v0.1.6：检索兜底优化——当文本检索返回空结果时，自动尝试 DuckDuckGo 新闻检索（news）以提升命中率；同步版本号与文案说明。
- v0.1.7：中文过滤导致空集的兜底策略——当中文过滤后为 0 条时，自动使用未过滤原始结果继续流程；报告页新增“开发者调试”计数（仅在 debug 模式显示）。
- v0.1.8：检索强化——DuckDuckGo 文本先中文区域（cn-zh）、再全球区域（wt-wt）；若仍为空则转新闻检索（含 timelimit 与区域兜底），显著提升命中率。
- v0.1.9：内容检索实战增强——默认启用 RSS 新闻源（NYTimes 中文、RFA、ThePaper/36kr/IT之家 via RSSHub）；实现“自动增广”策略（初次结果为 0 时，自动扩大时间窗到近一年、关闭中文与域名过滤并重试）；引入简易域名权重表提升主流中文来源排序；页面调试区显示增广触发与计数。
- v0.1.10：新增自动化冒烟测试脚本（mvp/tests/search_smoke.py），批量验证 DuckDuckGo 与 RSS 检索；每次更新同步版本号。若测试均为 0 条，提示网络或依赖异常以便定位。
- v0.1.11：修复检索兼容（优先使用新包 ddgs 导入 DDGS）；在所有检索与增广都为 0 条时，注入保底来源（维基百科/百度百科），避免页面空白，同时在调试区明确标记。
- v0.1.12：新增百度网页检索适配器作为国内兜底；在主流程中当 DuckDuckGo 为空时自动切换到百度；冒烟测试加入百度验证，提升在受限网络环境下的命中率。
- v0.1.13：增广策略升级——在自动增广阶段加入多关键字与英文别名（“导演/电影/Wong Kar-wai”）的合并检索；DuckDuckGo 仍为空时自动并入百度兜底结果，显著提高命中率并避免空白报告。
- v0.1.3：新增 Markdown 导出（舆情分析/output）；接入域名白/黑名单过滤；版本号更新为 v0.1.3。
- v0.1.2：首页新增“时间窗选择”（近7天/近30天/近90天近似）；报告页新增“数据说明与配置摘要”；配置版本号更新为 v0.1.2。
- v0.1.1：安装 duckduckgo-search；搜索功能可用；UI 显示版本号更新；技术日志与配置同步更新。
- v0.1.0：新增技术开发日志文档；记录 v0.1 模块与状态。